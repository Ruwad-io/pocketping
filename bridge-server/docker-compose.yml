services:
  bridge-server:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    env_file:
      - .env
    restart: unless-stopped

  # Development with hot reload
  dev:
    image: golang:1.22-alpine
    working_dir: /app
    volumes:
      - .:/app
    ports:
      - "3001:3001"
    env_file:
      - .env
    command: go run ./cmd/server

  # Build and lint
  build:
    image: golang:1.22-alpine
    working_dir: /app
    volumes:
      - .:/app
      - ../packages/sdk-go:/packages/sdk-go
      - go-mod-cache:/go/pkg/mod
    command: sh -c "go mod tidy && go build -o /dev/null ./cmd/server && echo '✅ Build successful'"

  # Lint check
  lint:
    image: golangci/golangci-lint:v1.55-alpine
    working_dir: /app
    volumes:
      - .:/app
      - go-mod-cache:/go/pkg/mod
    command: golangci-lint run ./...

  # Run tests
  test:
    image: golang:1.22
    working_dir: /app
    volumes:
      - .:/app
      - ../packages/sdk-go:/packages/sdk-go
      - go-mod-cache:/go/pkg/mod
    command: sh -c "go test -v -race -coverprofile=coverage.out ./... && go tool cover -func=coverage.out"

  # Run tests with coverage report
  test-coverage:
    image: golang:1.22
    working_dir: /app
    volumes:
      - .:/app
      - ../packages/sdk-go:/packages/sdk-go
      - go-mod-cache:/go/pkg/mod
    command: sh -c "go test -v -race -coverprofile=coverage.out ./... && go tool cover -html=coverage.out -o coverage.html && echo '✅ Coverage report generated at coverage.html'"

volumes:
  go-mod-cache:
